<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benford's Law Diagramm</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            transition: background-color 0.5s;
            margin: 0;
            padding: 0;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100vh;
            padding: 20px;
        }
        .customer-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .customer-info div {
            margin: 0 10px;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            width: 100%;
            gap: 10px;
            flex-grow: 1;
        }
        .chart {
            flex: 1 1 calc(50% - 10px);
            max-height: 45%;
        }
        .status {
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        .button-container button {
            padding: 10px 20px;
            background-color: #2c3e50;
            color: #ecf0f1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        .button-container button:hover {
            background-color: #34495e;
        }
    </style>
</head>   
<body>
    <div class="main-container">
        <!-- Kundeninfo oben links -->
        <div class="customer-info">
            <div><strong>Kunden Nr:</strong> <span id="kundenNr">-</span></div>
            <div><strong>Vorname:</strong> <span id="vorname">-</span></div>
            <div><strong>Nachname:</strong> <span id="nachname">-</span></div>
            <div><strong>Betriebsname:</strong> <span id="betriebsname">-</span></div>
            <div><strong>Zeitraum:</strong> <span id="zeitraum">-</span></div>
        </div>

        <div id="status" class="status">Keine Anomalien</div>

        <div class="chart-container">
            <div class="chart">
                <canvas id="benfordsChart"></canvas>
            </div>
            <div class="chart">
                <canvas id="yearlyChart"></canvas>
            </div>
            <div class="chart">
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>

        <div class="button-container">
            <button onclick="window.location.href='zweite.html'">Report Analyse</button>
        </div>
    </div>

    <script>
        // Fetch selected customer data from the backend
        fetch('/view_customer_data')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(customer => {
                // Populate customer information
                document.getElementById('kundenNr').innerText = customer.clientnumber;
                document.getElementById('vorname').innerText = customer.firstname;
                document.getElementById('nachname').innerText = customer.lastname;
                document.getElementById('betriebsname').innerText = customer.company;
                document.getElementById('zeitraum').innerText = customer.invoices_date ? `${customer.invoices_date[0]} - ${customer.invoices_date[customer.invoices_date.length - 1]}` : 'N/A';
    
                const statusElement = document.getElementById('status');
                if (customer.fraud) {
                    document.body.style.backgroundColor = 'rgba(200, 50, 50, 0.3)';
                    statusElement.innerText = 'Anomalie';
                    statusElement.style.color = 'darkred';
                } else {
                    document.body.style.backgroundColor = 'white';
                    statusElement.innerText = 'Keine Anomalien';
                    statusElement.style.color = 'rgba(50, 150, 150, 1)';
                }
    
                // Render Benford's Law Chart
                const firstDigitPercentages = customer.first_digit_percentages || {};
                const observedPercentages = Array.from({ length: 9 }, (_, i) => firstDigitPercentages[i + 1] || 0);
                const benfordsCtx = document.getElementById('benfordsChart').getContext('2d');
                new Chart(benfordsCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9'],
                        datasets: [
                            {
                                label: 'Invoice Distribution',
                                data: observedPercentages, // Observed percentages
                                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            },
                            {
                                label: "Benford's Law",
                                data: [30.1, 17.6, 12.5, 9.7, 7.9, 6.7, 5.8, 5.1, 4.6],
                                type: 'line',
                                backgroundColor: 'rgba(255, 99, 132, 1)',
                            },
                        ],
                    },
                    options: {
                        scales: {
                            y: {
                                ticks: {
                                    callback: function (value) {
                                        return value + '%'; // Add percentage sign
                                    },
                                },
                            },
                        },
                        responsive: true,
                        animation: {
                            duration: 2000,
                        },
                    },
                });

                // Render Yearly Chart
                const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
                new Chart(yearlyCtx, {
                    type: 'line',
                    data: {
                        labels: customer.invoices_date || [],
                        datasets: [
                            {
                                label: 'Invoices Over Time',
                                data: customer.invoices || [],
                                borderColor: 'rgba(75, 192, 192, 1)',
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 2000, // Animation duration in milliseconds (3 seconds)
                        },
                    },
                });
    
                // Render Quarterly Chart
                const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
                new Chart(monthlyCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                        datasets: [
                            {
                                label: 'Quarterly Revenue',
                                data: aggregateQuarterlyData(customer.invoices_date, customer.invoices),
                                backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 2000, // Animation duration in milliseconds
                        },
                    },
                });

                // Render Yearly Income Chart
                const incomeCtx = document.getElementById('incomeChart').getContext('2d');
                new Chart(incomeCtx, {
                    type: 'bar',
                    data: {
                        labels: extractYears(customer.invoices_date),
                        datasets: [
                            {
                                label: 'Yearly Income',
                                data: aggregateYearlyData(customer.invoices_date, customer.invoices),
                                backgroundColor: 'rgba(255, 159, 64, 0.5)',
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 2000, // Animation duration in milliseconds (3 seconds)
                        },
                    },
                });
            })
            .catch(error => console.error('Error loading customer data:', error));
    
        // Helper function to aggregate quarterly data
        function aggregateQuarterlyData(dates, amounts) {
            const quarterlyData = [0, 0, 0, 0]; // Q1, Q2, Q3, Q4
            if (!dates || !amounts) {
                console.error("Dates or amounts are missing:", { dates, amounts });
                return quarterlyData;
            }

            const currentYear = new Date().getFullYear(); // Get the current year
            console.log("Current Year:", currentYear);

            dates.forEach((date, index) => {
                // Match the "MMM YYYY" format using a regular expression
                const match = date.match(/^([A-Za-z]{3}) (\d{4})$/);
                if (!match) {
                    console.error("Invalid date format:", date);
                    return;
                }

                // Extract month and year
                const [_, monthStr, yearStr] = match;
                const monthMap = {
                    Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
                    Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11
                };
                const month = monthMap[monthStr];
                const year = parseInt(yearStr, 10);

                // Process only current-year invoices
                if (year === currentYear) {
                    const quarter = Math.floor(month / 3); // Map month to quarter (0 = Q1, 1 = Q2, etc.)
                    console.log(`Adding ${amounts[index]} to Q${quarter + 1} (Month: ${monthStr})`);
                    quarterlyData[quarter] += amounts[index];
                } else {
                    console.log(`Skipping invoice: ${date} (${year})`);
                }
            });

            console.log("Quarterly Data:", quarterlyData);
            return quarterlyData;
        }

        // Helper function to extract unique years
        function extractYears(dates) {
            if (!dates) return [];
            const years = dates.map(date => new Date(date).getFullYear());
            return [...new Set(years)];
        }
    
        // Helper function to aggregate yearly data
        function aggregateYearlyData(dates, amounts) {
            if (!dates || !amounts) return [];
            const yearlyData = {};
    
            dates.forEach((date, index) => {
                const year = new Date(date).getFullYear();
                yearlyData[year] = (yearlyData[year] || 0) + amounts[index];
            });
    
            return Object.values(yearlyData);
        }
    </script>
    
</body>
</html>
